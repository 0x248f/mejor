<!DOCTYPE html>
<html>
  <meta charset='utf-8'/>
  <header>
    <title>mejor</title>
    <style>
      h1 {
	  text-align: center;
      }

      table {
	  width: 100%;
      }

      #buffers {
	  border: 2px solid blue;
	  width: 12vw;
	  height: 80vh;
      }
      
      #ChatView {
	  margin-left: 2%;
	  margin-right: 12%;
	  margin-top: 2%;
	  margin-bottom: 3%;
      }
      
      textarea {
	  color: black;
	  border: 2px solid gold;
	  width: 100%;
	  height: 80vh;
	  resize: none;
      }

      input[type=text] {
	  width: 80%;
      }

      input[type=submit] {
	  border: none;
	  background-color: #abef00;
	  color: #1a2a3a;
	  width: 14%;
	  margin: 2px 2px;
	  padding: 8px 8px;
      }

      #bufferButtons input[type=button] {
	  border: 1px solid white;
	  background-color: #4400bb;
	  color: #dddddd;
	  width: 100%;
      }

      #bufferButtons.active input[type=button] {
	  background-color: green;
      }

      #bufferButtons.serverButton input[type=button] {
	  background-color: red;
      }
    </style>
  </header>
  <body>
    <h1>MEJOR</h1>
    <div id="root">
      <table>
	<tr>
	  <td>
	    <div id="buffers">
	      <div id="bufferButtons">
	      </div>
	    </div>
	  </td>
	  <td>
	    <div id="ChatView">
	      <textarea id="MsgBox" name="MsgBox" disabled></textarea>
	      <input id="input" type="text"/>
	      <input type="submit" onclick="submit()"/>
	    </div>
	  </td>
      </table>
    </div>
    
    <script>
      let msgBox = document.getElementById("MsgBox"),
	  input = document.getElementById("input"),
	  bufferButtons = document.getElementById("bufferButtons");
      let currentBuffer = ''; // Currently focused buffer name
      let currentTarget = {server: '', channel: ''}
      let buffers = {}; // Contains all buffers
      let channels = {}; // Contains channel lists per server
      let nick = {}; // Contains the nick for each server
      let socket = new_socket();

      function scrollMsgBox() {
	      msgBox.scrollTop = msgBox.scrollTopMax;
      }
      function addMessage(text) {
	      msgBox.value += text + '\r\n';
      }
      function clearInput() {
	      input.value = '';
      }
      input.addEventListener("keyup", (event) => {
	      if (event.keyCode === 13) // enter
		      submit();
      });

      function new_socket() {
	      let socket = new WebSocket("ws://localhost:4222");
	      socket.onmessage = processEvent;

	      return socket;
      }

      function processEvent(event) {
	      let message = parseMessage(event.data.trim());
	      if (!message)
		      return;

	      switch (message.command) {
	      case 'RECV':
		      return processRecv(message);
	      case 'CONNECT':
		      return processConnect(message);
	      case 'JOIN':
		      return processJoin(message);
	      case 'PART':
		      return processPart(message);
	      case 'NICK':
		      return processNick(message);
	      }
      }

      function parseMessage(msg) {
                let m = text.trim().match(/^([A-Z]+)\s+\'(.+)\'(?:\.(#[^\.\s]+))?(?:\.([^\.\s]+))?(?:\s*\|\s*(.+))?$/);
                if (m)
                        return {
                                'command': m[1],
                                'server': m[2],
                                'channel': m[3],
                                'user': m[4],
                                'data': m[5]
                        };
                else
                        return null;
      }

      function processRecv(msg) {
	      if (!msg.server || !msg.channel)
		      return;

	      let name = `'${msg.server}'.${msg.channel}`;
	      let text = msg.user + ': ' + msg.data + \r\n;
	      if (buffers[name])
		      buffers[name] += text;
	      else {
		      buffers[name] = text;
		      addChannel(msg.server, msg.channel);
	      }
	      if (name === currentBuffer) {
		      addMessage(text);
		      scrollMsgBox();
	      }
      }

      function processConnect(msg) {
	      if (msg.server)
		      addServer(msg.server);
      }

      function processJoin(msg) {
	      if (msg.server && msg.channel)
		      addChannel(msg.server, msg.channel);
      }

      function processPart(msg) {
	      if (msg.server && msg.channel)
		      removeChannel(msg.server, msg.channel);
      }

      function processNick(msg) {
	      if (msg.server && msg.user === myNick && msg.data)
		      nick[msg.server] = data;
	      else if (msg.server && msg.user && !msg.data)
		      nick[msg.server] = msg.user;
      }
      
      function submit() {
	      if (input.value === '')
		      return;
	      if (socket.readyState > 1)
		      socket = new_socket();

	      let text = input.value;
	      socket.send(`SEND ${currentBuffer} | ${text}\r\n`);
	      addMessage(`${nick[currentTarget.server]}: ${text}`);
	      scrollMsgBox();
	      clearInput();
      }

      function addServer(name) {
	      if (document.getElementById(name))
		      return;

	      let html = `<div id="${name}><input class="serverButton" type="button" value="${name}" onclick="switchBuffer(${name})"/></div>`;
	      bufferButtons.innerHTML += html;
	      buffers[name] = '';
	      channels[name] = [];
	      switchBuffer(name);
      }

      function removeServer(name) {
	      let serverDiv = document.getElementById(name);
	      if (serverDiv)
		      bufferButtons.removeChild(serverDiv);
      }

      function addChannel(server, channel) {
	      let serverDiv = document.getElementById(server);
	      let name = `'${server}'.${channel}`;
	      if (document.getElementById(name))
		      return;

	      let html = `<input id="${name}" type="button" value="${channel}" onclick="switchBuffer('${name}')"/>`;
	      serverDiv.innerHTML += html;
	      buffers[name] = '';
	      channels[server].push(channel);
      }

      function removeChannel(server, channel) {
	      let name = `'${server}'.${channel}`;
	      let parent = document.getElementById(server);
	      let child = document.getElementById(name);

	      if (parent && child)
		      parent.removeChild(child);
      }

      function switchBuffer(name) {
	      if (!buffers[name] && buffers[name] !== '')
		      return;

	      let m = name.match(/^\'(.+)\'\.(#[^\.\s]+)$/)
	      if (m)
		      currentTarget = {'server': m[1], 'channel': m[2]};
	      else
		      currentTarget = {'server': name};

	      if (currentBuffer) {
		      buffers[currentBuffer] = msgBox.value;
		      bufferButtons[currentBuffer].className = '';
	      }

	      if (buffers[name] && bufferButtons[name]) {
		      msgBox.value = buffers[name];
		      bufferButtons[name].className = 'active';
		      currentBuffer = name;
		      input.focus();
	      }
      }
    </script>
  </body>
</html>
